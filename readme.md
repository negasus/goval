# Goval

Goval is a tool for generate validation functions for Go structs.

Goval uses struct tags to generate validation functions for the struct fields.

See [examples](examples).

## Install

```bash
go install github.com/negasus/goval/cmd/goval@latest
```

## Usage

Add tags to struct fields and run `goval` command from current directory.

```go
type Request struct {
    Name string `goval:"min=3;max=10"`
    Age  int    `goval:"min=18"`
}
```

```bash
goval --type Request
```

I recommend use `go:generate` directive.

```go
//go:generate goval --type Request
```

```bash
go generate ./...
```

Goval will generate a file `goval_request.go` with validation functions for the struct.

```go
// Code generated by goval. DO NOT EDIT.
// Used flags: -t Request

package main

import "github.com/negasus/goval"

func (model *Request) Validate() goval.Errors {
    errors := goval.Errors{}

    { // Name
        if len(model.Name) < 3 {
            errors["Name"] = append(errors["Name"], goval.Error{
                Type: goval.ErrorTypeMinString,
                Values: map[string]any{
                    "field": "Name",
                    "min":   3,
                },
            })
        }
    }
    { // Name
        if len(model.Name) > 10 {
            errors["Name"] = append(errors["Name"], goval.Error{
                Type: goval.ErrorTypeMaxString,
                Values: map[string]any{
                    "field": "Name",
                    "min":   10,
                },
            })
        }
    }
    { // Age
        if model.Age < 18 {
            errors["Age"] = append(errors["Age"], goval.Error{
                Type: goval.ErrorTypeMinNumeric,
                Values: map[string]any{
                    "field": "Age",
                    "min":   18,
                },
            })
        }
    }

    return errors
}
```

## CLI flags

- `-t` or `--type` - type name, you can use multiple types `-t One -t Two`, required
- `-o` or `--output` - output file name (default: `goval_{snake_cased_type}.go`)
- `-d` or `--debug` - debug mode, verbose output, default false
- `-n` or `--tag` - struct tag name, default `goval`

## Rules

Rules are defined in the struct tags with the `goval` key.

You can use multiple rules separated by `;`.

### max

For int values, it's the maximum value.

For string values, it's the maximum length.

```go
type Request struct {
	Name string `goval:"max=10"`
	Age  int    `goval:"max=18"`
}
```

### min

For int values, it's the minimum value.

For string values, it's the minimum length.

```go
type Request struct {
	Name string `goval:"min=3"`
	Age  int    `goval:"min=18"`
}
```

### in

For string and int values, it's a list of valid values separated by `,`.

```go
type Pagination struct {
	PerPage int `goval:"in=10,20,30"`
	Keys string `goval:"in=foo,bar,'with , comma'"`
}
```

You can use syntax `in={variable_name}` to use a variable as the list of valid values.

```go
var validKeys = []string{"foo", "bar"}

type Request struct {
	Key string `goval:"in={validKeys}"`
}
```

### custom validation function

You can use a custom validation function.

```go
type Request struct {
    Name string `goval:"@customValidate"`
}

func (r *Request) customValidate() goval.Errors {
    errors := goval.Errors{}

    e := goval.NewError(goval.ErrorTypeInvalid).
        AddValue("field", "Custom")

    errors.Add("Custom", e)

    return errors
}
```

Custom validation function must return `goval.Errors` and have no arguments.

See example in [examples/simple](examples/simple).

You can use alias `@` for call `Valiadate()` function for embedded structs.

```go
//go:generate goval --type Request --type Meta

type Meta struct {
	ID int `goval:"min=1"`
}

type Request struct {
	Meta `goval:"@"`
	Name string `goval:"min=3;max=10"`
}

```

## Error messages

Type `Error` implements `Stringer` interface and has two methods to generate error messages.

- `String()` - returns a string representation of the error with default language.
- `StringLang(ln string)` - returns a string representation of the error with the specified language.

Now the tool supports only English and Russian languages.

The default language is English.

You can redefine the default language by call `SetDefaultLang("ru")`.

### Custom error messages

You can use a custom error message for the field.

```go
var customMessageID = 1

func main() {
    goval.AddCustomMessage(customMessageID, "en", "My Message {value}")
}

type Request struct {
    Name string `goval:"@customValidate"`
}

func (r *Request) customValidate() goval.Errors {
    errors := goval.Errors{}

    e := goval.NewCustomError(customMessageID).AddValue("value", c.Index)

    errors.Add("Name", e)

    return errors
}
```

Custom Message ID must be unique and greater than 0.
